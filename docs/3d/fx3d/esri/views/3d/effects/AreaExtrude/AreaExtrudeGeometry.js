/**
 * Copyright @ 2018 Esri.
 * All rights reserved under the copyright laws of the United States and applicable international laws, treaties, and conventions.
 */
define(["esri/core/declare","esri/geometry/support/centroid","esri/views/3d/support/PromiseLightweight","esri/views/3d/layers/graphics/Graphics3DSymbolCommonCode","esri/core/libs/earcut/earcut","esri/core/libs/gl-matrix-2/gl-matrix","../../support/geometryUtils"],function(t,e,n,i,r,p,s){var a=p.vec3f64,o=p.vec3,d=a.create(),h=a.create(),c=a.create(),u=a.create(),x=a.create(),l=a.create(),f=a.create(),m=a.create(),g=6378137,v={Down:0,Up:1},y=Math.cos(5*(Math.PI/180)),_=100.11,b=t(n.Promise,{constructor:function(t,n,r){var p=t.geometry.rings,s={rings:p,hasZ:!1};this.center=e.polygonCentroid(s),this._geometryData=i.copyPathData(p,t.geometry.hasZ),this._geometryData&&n>=0&&r>=0?(this.index=n,this.stride=r,this.resolve()):this.reject()},createBuffers:function(t,e){var n,p,a,o,d,h,c,u,x=this._geometryData.polygons,l=[],f=this._geometryData.vertexData;if(!f)return l;var m=f.length/3,g=new Float64Array(f.length);i.reproject(f,0,t,g,0,e,m);for(var y=new Float64Array(g),b=0;b<x.length;++b){n=x[b],c=n.count,u=n.index;var w=new Float64Array(f.buffer,3*u*f.BYTES_PER_ELEMENT,3*c);if(p=n.holeIndices.map(function(t){return t-u}),a=r(w,p,3),!(a.length<1)){var D={polygonIndex:b},E=new Float64Array(y.buffer,3*u*y.BYTES_PER_ELEMENT,3*c),z=this._computeNormalAndDistance(E);D.dist=z.distance;var A=s.getOrigin(g,m,u,c);if(A){D.origin=A;var N=[],U=[];o=n.count,d=2*o;for(var M=0;M<o;M++)h=M*this.stride,N[0+h]=w[0+3*M],N[1+h]=w[1+3*M],N[2+h]=1,N[3+h]=this.index,N[4+h]=v.Down,N[5+h]=this.center[0],N[6+h]=this.center[1],h=(M+o)*this.stride,N[0+h]=w[0+3*M],N[1+h]=w[1+3*M],N[2+h]=_,N[3+h]=this.index,N[4+h]=v.Up,N[5+h]=this.center[0],N[6+h]=this.center[1];for(var F=0,P=0,L=0;L<n.pathLengths.length;L++){P=n.pathLengths[L];for(var S=0;S<P;S++)S!==P-1?U.push(S+1+F,S+F,S+1+o+F,S+1+o+F,S+F,S+o+F):U.push(0+F,S+F,0+o+F,0+o+F,S+F,S+o+F);F+=P}this._subdivision2(w,E,a,o,N,U),D.indexNums=U.length,D.vertexNum=N.length/this.stride,D.vertices=new Float32Array(N),D.indices=new Uint32Array(U),l.push(D)}}}return l},_computeNormalAndDistance:function(t){var e=0,n=3,i=6;o.set(d,t[e++],t[e++],t[e++]),o.set(h,t[n++],t[n++],t[n++]),o.set(c,t[i++],t[i++],t[i++]),o.subtract(u,d,h),o.subtract(x,c,h);var r=a.create();o.cross(r,u,x),o.normalize(r,r);var p=Math.abs(o.dot(r,d)),s=g-p,l=o.normalize(d,d),f=o.dot(r,l),m=Math.abs(s/f);return{normal:r,distance:m}},_subdivision:function(t,e,n,i,r,p){for(var s,a,o,d,h,c,u,x,l=e.length/3,f=0,m=0,g=0;g<l;g++)d=e[f++],h=e[f++],c=e[f++],s=3*d,a=3*h,o=3*c,u=(t[s]+t[a]+t[o])/3,x=(t[s+1]+t[a+1]+t[o+1])/3,r.push(u,x,_,this.index,v.Up,this.center[0],this.center[1]),p.push(d+n,h+n,i+m),p.push(h+n,c+n,i+m),p.push(c+n,d+n,i+m),m++},_doSubdivision:function(t,e,n){if(t.length>0)for(var i,r,p,s,d,h,c,u,x,g,b=-1,w=e.length/this.stride;null!=(i=t.pop());)if(o.copy(l,i.pt0),o.copy(f,i.pt1),o.copy(m,i.pt2),i.n0||(i.n0=a.create(),o.normalize(i.n0,l)),i.n1||(i.n1=a.create(),o.normalize(i.n1,f)),i.n2||(i.n2=a.create(),o.normalize(i.n2,m)),r=o.dot(i.n0,i.n1),p=o.dot(i.n1,i.n2),s=o.dot(i.n0,i.n2),r<y||p<y||s<y){if(d=Math.min(r,p,s),!isNaN(d)&&null!=d)if(d==r){b++,h=.5*(l[0]+f[0]),c=.5*(l[1]+f[1]),u=.5*(l[2]+f[2]),x=.5*(i.pt00[0]+i.pt11[0]),g=.5*(i.pt00[1]+i.pt11[1]);var D=a.fromValues(h,c,u);o.normalize(D,D),t.push({pt0:i.pt0,pt1:[h,c,u],pt2:i.pt2,pt00:i.pt00,pt11:[x,g],pt22:i.pt22,index0:i.index0,index1:w+b,index2:i.index2,n0:i.n0,n1:D,n2:i.n2}),t.push({pt0:[h,c,u],pt1:i.pt1,pt2:i.pt2,pt00:[x,g],pt11:i.pt11,pt22:i.pt22,index0:w+b,index1:i.index1,index2:i.index2,n0:D,n1:i.n1,n2:i.n2}),e.push(x,g,_,this.index,v.Up,this.center[0],this.center[1]),n.push(w+b,i.index0,i.index1)}else if(d==p){b++,h=.5*(f[0]+m[0]),c=.5*(f[1]+m[1]),u=.5*(f[2]+m[2]),x=.5*(i.pt22[0]+i.pt11[0]),g=.5*(i.pt22[1]+i.pt11[1]);var D=a.fromValues(h,c,u);o.normalize(D,D),t.push({pt0:i.pt0,pt1:i.pt1,pt2:[h,c,u],pt00:i.pt00,pt11:i.pt11,pt22:[x,g],index0:i.index0,index1:i.index1,index2:w+b,n0:i.n0,n1:i.n1,n2:D}),t.push({pt0:i.pt0,pt1:[h,c,u],pt2:i.pt2,pt00:i.pt00,pt11:[x,g],pt22:i.pt22,index0:i.index0,index1:w+b,index2:i.index2,n0:i.n0,n1:D,n2:i.n2}),e.push(x,g,_,this.index,v.Up,this.center[0],this.center[1]),n.push(w+b,i.index1,i.index2)}else if(d==s){b++,h=.5*(l[0]+m[0]),c=.5*(l[1]+m[1]),u=.5*(l[2]+m[2]),x=.5*(i.pt22[0]+i.pt00[0]),g=.5*(i.pt22[1]+i.pt00[1]);var D=a.fromValues(h,c,u);o.normalize(D,D),t.push({pt0:i.pt0,pt1:i.pt1,pt2:[h,c,u],pt00:i.pt00,pt11:i.pt11,pt22:[x,g],index0:i.index0,index1:i.index1,index2:w+b,n0:i.n0,n1:i.n1,n2:D}),t.push({pt0:[h,c,u],pt1:i.pt1,pt2:i.pt2,pt00:[x,g],pt11:i.pt11,pt22:i.pt22,index0:w+b,index1:i.index1,index2:i.index2,n0:D,n1:i.n1,n2:i.n2}),e.push(x,g,_,this.index,v.Up,this.center[0],this.center[1]),n.push(w+b,i.index2,i.index0)}}else n.push(i.index0,i.index1,i.index2)},_subdivision2:function(t,e,n,i,r,p){for(var s,a,o,d,h,c,u=n.length/3,x=0,l=0;l<u;l++)d=n[x++],h=n[x++],c=n[x++],s=3*d,a=3*h,o=3*c,this._doSubdivision([{pt0:[e[s],e[s+1],e[s+2]],pt1:[e[a],e[a+1],e[a+2]],pt2:[e[o],e[o+1],e[o+2]],pt00:[t[s],t[s+1]],pt11:[t[a],t[a+1]],pt22:[t[o],t[o+1]],index0:d+i,index1:h+i,index2:c+i}],r,p)},destroy:function(){this.isFulfilled()||this.reject()}});return b});